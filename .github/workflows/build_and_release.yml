name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write  # Required for creating releases

jobs:
  build-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Build GUI fat JAR
        run: |
          ./gradlew :app:clean :app:fatJarGui -x test

      - name: Create macOS installer (dmg) using jpackage
        env:
          APP_NAME: "PackerGUI"
          MAIN_CLASS: "archdesign.gui.GuiApp"
          APP_VERSION: ${{ github.ref_name }}
        run: |
          set -e
          # Strip a leading 'v' from tag names like 'v1.0.0' so jpackage receives a numeric version
          APP_VERSION="${APP_VERSION#v}"
          echo "Normalized app version: $APP_VERSION"
          mkdir -p installer
          # pick GUI jar if available, otherwise first jar
          JAR=$(ls app/build/libs/*gui*.jar 2>/dev/null || ls app/build/libs/*.jar | head -n 1)
          echo "Using jar: $JAR"
          JAR_BASENAME=$(basename "$JAR")
          jpackage --input app/build/libs --name "$APP_NAME" --main-jar "$JAR_BASENAME" --main-class "$MAIN_CLASS" --type dmg --dest installer --app-version "$APP_VERSION"

      - name: Upload Mac DMG
        uses: actions/upload-artifact@v4
        with:
          name: mac-dmg
          path: installer/*.dmg
          retention-days: 1

  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build GUI fat JAR (Windows)
        shell: powershell
        run: |
          .\gradlew.bat :app:clean :app:fatJarGui -x test

      - name: Create Windows installer (exe) using jpackage
        shell: powershell
        env:
          APP_NAME: "PackerGUI"
          MAIN_CLASS: "archdesign.gui.GuiApp"
          APP_VERSION: ${{ github.ref_name }}
        run: |
          # Normalize tag like 'v1.0.0' to '1.0.0' for Windows installer product version requirements
          $appVersion = $env:APP_VERSION.TrimStart('v')
          Write-Host "Normalized app version: $appVersion"
          mkdir installer
          $jar = Get-ChildItem -Path app\build\libs\*gui*.jar -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $jar) { $jar = Get-ChildItem -Path app\build\libs\*.jar | Select-Object -First 1 }
          Write-Host "Using jar: $($jar.Name)"
          jpackage --input "app\build\libs" --name $env:APP_NAME --main-jar $jar.Name --main-class $env:MAIN_CLASS --type exe --dest installer --app-version $appVersion

      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: installer/*.exe
          retention-days: 1
  create-release:
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Mac DMG
        uses: actions/download-artifact@v4
        with:
          name: mac-dmg
          path: ./artifacts/mac
      
      - name: Download Windows EXE
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: ./artifacts/windows

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/mac/*.dmg
            ./artifacts/windows/*.exe
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
